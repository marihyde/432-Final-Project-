
## Question 3

```{r message=F, warning=F}
library(dplyr)
library(ggplot2)
library(stringr)
library(cowplot)
library(ggrepel)
source("http://bit.ly/theme_pub")
```

```{r}
data = read.table("./data/rawGeneExpression.txt", header=T, sep = "\t")

# remove unwanted columns & rename
data = data %>% 
  select(1:5) %>%
  rename(Bacteria = X)

data$Bacteria = str_extract(data$Bacteria, "^[^;]+") # removing extra stuff from bacteria name
```

```{r warning=F}
PCA_data = as.data.frame(scale(data[2:5])) # scale data

PCA = princomp(PCA_data, cor=T) # run PCA

PCA_data$PC1 = PCA$scores[,1] # getting PC axes for plot
PCA_data$PC2 = PCA$scores[,2]
PCA_data$Bacteria = data$Bacteria # add names back for colour coding

ggplot(data=PCA_data, aes(x=PC1, y=PC2, colour=Bacteria)) + geom_point() + theme_pub() # plot is bad, we will remove outliers
```

```{r warning=FALSE}
PCA_data = PCA_data[-which(PCA_data$PC1 > -0.15),] # remove outliers, only 41 observation difference

# plot
x = ggplot(data=PCA_data, aes(x=PC1, y=PC2, colour=Bacteria)) + geom_point() + theme(legend.text = element_text(size = 8), legend.key.size = unit(0.5, "cm"))

# get and print legend (legend too big to print with graph)
legend = get_legend(x) 
plot_grid(legend)
```

```{r}
# get labels
labels = function(x) {
  words = unlist(strsplit(x, " "))
  abbr = paste0(substr(words, 1, 1), collapse = ".")
  return(abbr)
}

# add labels
PCA_data = PCA_data %>%
    mutate(label = sapply(Bacteria, labels))

# plot with labels
x + theme_pub() + geom_text_repel(data = PCA_data, aes(label = ifelse(Bacteria == "Rickettsia buchneri", "", label)), size = 3, alpha = 0.5)
```

```{r warning=F}
# set up data for correlation calculations
grouped_data = PCA_data %>%
  group_by(Bacteria) %>%
  summarise(across(starts_with("X"), mean))

rownames(grouped_data) = grouped_data$Bacteria
cor_data = t(grouped_data)
cor_data = as.data.frame(cor_data[-1,])
cor_data[] = lapply(cor_data, as.numeric)
```

```{r}
# correlation with Anaplasma phagocytophilum

correlations_ap = data.frame(Comparison = character(), Correlation = numeric())

for (i in 1:ncol(cor_data)){
  x = cor(cor_data$`Anaplasma phagocytophilum`, cor_data[[i]])
  y = data.frame(Comparison = sprintf("Anaplasma phagocytophilum vs. %s", colnames(cor_data[i])), Correlation = x)
  correlations_ap = rbind(correlations_ap, y)
}

correlations_ap = correlations_ap %>%
  arrange(desc(Correlation))
```

```{r}
# correlation with Borreliella burgdorferi

correlations_bb = data.frame(Comparison = character(), Correlation = numeric())

for (i in 1:ncol(cor_data)){
  x = cor(cor_data$`Borreliella burgdorferi`, cor_data[[i]])
  y = data.frame(Comparison = sprintf("Borreliella burgorferi vs. %s", colnames(cor_data[i])), Correlation = x)
  correlations_bb = rbind(correlations_bb, y)
}

correlations_bb = correlations_bb %>%
  arrange(desc(Correlation))
```

```{r}
# correlation with Borrelia miyamotoi

correlations_bm = data.frame(Comparison = character(), Correlation = numeric())

for (i in 1:ncol(cor_data)){
  x = cor(cor_data$`Borrelia miyamotoi`, cor_data[[i]])
  y = data.frame(Comparison = sprintf("Borrelia miyamotoi vs. %s", colnames(cor_data[i])), Correlation = x)
  correlations_bm = rbind(correlations_bm, y)
}

correlations_bm = correlations_bm %>%
  arrange(desc(Correlation))
```


```{r}
head(correlations_ap)
head(correlations_bb)
head(correlations_bm)
```











